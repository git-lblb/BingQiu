<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†åŒºå°çƒå¼¹å°„æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            background-color: #f0f0f0;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* è®¡åˆ†æ¿å’Œæç¤º */
        .score-board {
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .turn-tip {
            margin-bottom: 10px;
            font-size: 16px;
            color: #666;
        }

        .win-tip {
            margin-top: 15px;
            font-size: 18px;
            font-weight: bold;
            color: #e63946;
            display: none;
        }

        /* ä¸»å®¹å™¨ï¼šé€‚é…æ‰‹æœºå®½åº¦ */
        .main-rect {
            width: 90vw;
            max-width: 330px;
            height: 60vh;
            min-height: 500px;
            border: 3px solid #333;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .area {
            flex: 1;
            position: relative;
        }
        /* 1/4åŒºç™½è‰²èƒŒæ™¯ï¼Œ3åŒºç²‰è‰²èƒŒæ™¯ */
        #area1 { background-color: #ffffff; }
        #area2 { background-color: #4ecdc4; }
        #area3 { background-color: #ffc0cb; } /* ç²‰è‰² */
        #area4 { background-color: #ffffff; }

        /* ç§»é™¤åŒºåŸŸç¼–å·æ ·å¼ */

        /* å°çƒåŸºç¡€æ ·å¼ */
        .ball {
            border-radius: 50%;
            border: 2px solid #333;
            position: absolute;
            cursor: grab;
            user-select: none;
            z-index: 10;
        }

        /* å°çƒå°ºå¯¸ */
        .ball.size-xs { width: 12px; height: 12px; } /* å° */
        .ball.size-sm { width: 18px; height: 18px; } /* ä¸­ */
        .ball.size-md { width: 24px; height: 24px; } /* å¤§ */
        .ball.size-lg { width: 30px; height: 30px; } /* ç‰¹å¤§ */

        /* å°çƒé¢œè‰² */
        .ball.blue { background-color: #4287f5; }
        .ball.red { background-color: #e63946; }

        /* ä¸å¯æ“ä½œå°çƒ */
        .ball.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <div class="score-board">ç©å®¶1å¾—åˆ†ï¼š<span id="score1">0</span> | ç©å®¶2å¾—åˆ†ï¼š<span id="score2">0</span></div>
    <div class="turn-tip" id="turnTip">å½“å‰è½®åˆ°ï¼šç©å®¶1ï¼ˆæ“ä½œåŒºåŸŸ1å†…å°çƒï¼‰</div>
    <div class="win-tip" id="winTip"></div>

    <div class="main-rect" id="mainRect">
        <div class="area" id="area1"></div>
        <div class="area" id="area2"></div>
        <div class="area" id="area3"></div>
        <div class="area" id="area4"></div>
    </div>

    <script>
        // åˆå§‹åŒ–å…ƒç´ 
        const mainRect = document.getElementById('mainRect');
        const area1 = document.getElementById('area1');
        const area2 = document.getElementById('area2');
        const area3 = document.getElementById('area3');
        const area4 = document.getElementById('area4');
        const allAreas = document.querySelectorAll('.area');
        const score1El = document.getElementById('score1');
        const score2El = document.getElementById('score2');
        const turnTip = document.getElementById('turnTip');
        const winTip = document.getElementById('winTip');
        
        const ballCount = 7;
        const sizeOrder = ['size-xs', 'size-sm', 'size-md', 'size-lg', 'size-md', 'size-sm', 'size-xs'];
        // ä»¥ç‰¹å¤§çƒä¸ºä¸­å¿ƒçš„æ¨ªå‘åç§»é‡
        const centerOffsets = [-90, -60, -30, 0, 30, 60, 90];
        let currentPlayer = 1;
        let scores = { 1: 0, 2: 0 };
        let balls = []; 
        let gameOver = false; 

        // æ£€æµ‹åŒºåŸŸå†…å°çƒ
        function hasBallInArea(targetArea) {
            return balls.some(ball => ball.belongArea === targetArea);
        }

        // æ›´æ–°å°çƒé¢œè‰²
        function updateBallColor(ball) {
            if (ball.belongArea === area1) {
                ball.element.classList.remove('red');
                ball.element.classList.add('blue');
            } else if (ball.belongArea === area4) {
                ball.element.classList.remove('blue');
                ball.element.classList.add('red');
            }
        }

        class Ball {
            constructor(belongArea, index) {
                this.belongArea = belongArea; 
                this.operatedBy = null; 
                this.dragStartArea = null;
                this.startX = 0;
                this.startY = 0;
                this.lastX = 0;
                this.lastY = 0;
                this.sizeClass = sizeOrder[index];

                this.element = document.createElement('div');
                this.element.className = `ball ${this.sizeClass}`;
                mainRect.appendChild(this.element);

                // åŸºäºç‰¹å¤§çƒå±…ä¸­çš„ä½ç½®è®¡ç®—
                const areaRect = this.belongArea.getBoundingClientRect();
                const mainRectRect = mainRect.getBoundingClientRect();
                // åŒºåŸŸæ°´å¹³ä¸­å¿ƒ
                const areaCenterX = areaRect.left + areaRect.width / 2 - mainRectRect.left;
                // åŒºåŸŸå‚ç›´ä¸­å¿ƒ
                const areaCenterY = areaRect.top + areaRect.height / 2 - mainRectRect.top;
                // æ ¹æ®åç§»é‡å®šä½ï¼Œç‰¹å¤§çƒï¼ˆindex=3ï¼‰åç§»0ï¼Œå±…ä¸­
                this.x = areaCenterX + centerOffsets[index] - parseInt(getComputedStyle(this.element).width)/2;
                this.y = areaCenterY - parseInt(getComputedStyle(this.element).height)/2;
                this.vx = 0;
                this.vy = 0;
                this.isDragging = false;

                this.areaSlideCount = { 1:0, 2:0, 3:0, 4:0 };
                this.areaSlideCount[this.belongArea.dataset.id]++;

                updateBallColor(this);
                this.updatePosition();
                this.updateBallStatus();
                this.bindEvents();
            }

            updatePosition() {
                this.element.style.left = `${this.x}px`;
                this.element.style.top = `${this.y}px`;
            }

            updateBallStatus() {
                if (gameOver) {
                    this.element.classList.add('disabled');
                    return;
                }
                const areaId = this.belongArea.id === 'area1' ? '1' : this.belongArea.id === 'area4' ? '4' : '';
                this.element.classList.toggle('disabled', !(
                    (currentPlayer === 1 && areaId === '1') || 
                    (currentPlayer === 2 && areaId === '4')
                ));
            }

            bindEvents() {
                // é¼ æ ‡æŒ‰ä¸‹ / è§¦å±å¼€å§‹
                this.element.addEventListener('mousedown', (e) => this.startDrag(e.clientX, e.clientY));
                this.element.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    this.startDrag(touch.clientX, touch.clientY);
                });

                // é¼ æ ‡ç§»åŠ¨ / è§¦å±æ»‘åŠ¨
                document.addEventListener('mousemove', (e) => {
                    if (this.isDragging) this.moveDrag(e.clientX, e.clientY);
                });
                document.addEventListener('touchmove', (e) => {
                    if (this.isDragging) {
                        e.preventDefault();
                        const touch = e.touches[0];
                        this.moveDrag(touch.clientX, touch.clientY);
                    }
                });

                // é¼ æ ‡æ¾å¼€ / è§¦å±ç»“æŸ
                document.addEventListener('mouseup', () => this.endDrag());
                document.addEventListener('touchend', () => this.endDrag());
            }

            // å¼€å§‹æ‹–æ‹½
            startDrag(clientX, clientY) {
                if (gameOver || this.element.classList.contains('disabled')) return;
                
                this.isDragging = true;
                this.operatedBy = currentPlayer;
                this.dragStartArea = this.belongArea.getBoundingClientRect();
                this.element.style.cursor = 'grabbing';
                
                const ballRect = this.element.getBoundingClientRect();
                const mainRectRect = mainRect.getBoundingClientRect();
                // è®¡ç®—é¼ æ ‡/è§¦å±åœ¨å°çƒå†…çš„ç›¸å¯¹ä½ç½®
                this.startX = clientX - (ballRect.left - mainRectRect.left);
                this.startY = clientY - (ballRect.top - mainRectRect.top);
                this.lastX = clientX;
                this.lastY = clientY;
            }

            // æ‹–æ‹½ç§»åŠ¨
            moveDrag(clientX, clientY) {
                const mainRectRect = mainRect.getBoundingClientRect();
                const ballHeight = parseInt(getComputedStyle(this.element).height);
                // è®¡ç®—ç›®æ ‡ä½ç½®
                let targetX = clientX - this.startX;
                let targetY = clientY - this.startY;

                // é™åˆ¶Yè½´åœ¨èµ·å§‹åŒºåŸŸå†…
                const areaTop = this.dragStartArea.top - mainRectRect.top;
                const areaBottom = this.dragStartArea.bottom - mainRectRect.top - ballHeight;
                targetY = Math.max(areaTop, Math.min(targetY, areaBottom));

                this.x = targetX;
                this.y = targetY;
                this.updatePosition();

                // è®¡ç®—æ»‘åŠ¨é€Ÿåº¦
                this.vx = (clientX - this.lastX) * 1.5;
                this.vy = (clientY - this.lastY) * 1.5;
                this.lastX = clientX;
                this.lastY = clientY;
            }

            // ç»“æŸæ‹–æ‹½
            endDrag() {
                if (!this.isDragging) return;
                
                this.isDragging = false;
                this.element.style.cursor = 'grab';
                this.dragStartArea = null;
                this.startMove();
                switchPlayer();
            }

            startMove() {
                const mainRectRect = mainRect.getBoundingClientRect();
                const ballRadius = parseInt(getComputedStyle(this.element).width)/2;
                const animate = () => {
                    if (gameOver) return;

                    if (Math.abs(this.vx) < 0.1 && Math.abs(this.vy) < 0.1) {
                        const oldArea = this.belongArea;
                        this.checkAreaChange();
                        updateBallColor(this);
                        this.checkSlideCount();
                        checkGameOver();
                        return;
                    }

                    // è¾¹ç•Œåå¼¹
                    if (this.x - ballRadius <= 0 || this.x + ballRadius >= mainRectRect.width) {
                        this.vx = -this.vx * 0.8;
                        this.x = Math.max(ballRadius, Math.min(this.x, mainRectRect.width - ballRadius));
                    }
                    if (this.y - ballRadius <= 0 || this.y + ballRadius >= mainRectRect.height) {
                        this.vy = -this.vy * 0.8;
                        this.y = Math.max(ballRadius, Math.min(this.y, mainRectRect.height - ballRadius));
                    }

                    this.x += this.vx;
                    this.y += this.vy;
                    this.updatePosition();

                    this.vx *= 0.98;
                    this.vy *= 0.98;
                    requestAnimationFrame(animate);
                };
                requestAnimationFrame(animate);
            }

            checkAreaChange() {
                const ballRect = this.element.getBoundingClientRect();
                const ballCenterY = ballRect.top + ballRect.height/2;
                let finalArea = null;

                allAreas.forEach(area => {
                    const rect = area.getBoundingClientRect();
                    if (ballCenterY >= rect.top && ballCenterY <= rect.bottom) {
                        finalArea = area;
                    }
                });

                if (!finalArea) return;

                // å¾—åˆ†åˆ¤å®š
                if ((this.operatedBy === 1 && finalArea === area3) || (this.operatedBy === 2 && finalArea === area2)) {
                    scores[this.operatedBy]++;
                    updateScore();
                }

                this.belongArea = finalArea;
                this.areaSlideCount[finalArea.id]++;
                this.operatedBy = null;
            }

            checkSlideCount() {
                const areaId = this.belongArea.id;
                if (this.areaSlideCount[areaId] > 3) {
                    this.element.remove();
                    balls = balls.filter(ball => ball !== this);
                }
            }
        }

        // åˆ‡æ¢ç©å®¶
        function switchPlayer() {
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            const currentArea = currentPlayer === 1 ? area1 : area4;
            if (!hasBallInArea(currentArea)) {
                currentPlayer = currentPlayer === 1 ? 2 : 1;
                const newArea = currentPlayer === 1 ? area1 : area4;
                if (!hasBallInArea(newArea)) {
                    gameOver = true;
                    showWinResult();
                    return;
                }
            }
            turnTip.textContent = `å½“å‰è½®åˆ°ï¼šç©å®¶${currentPlayer}ï¼ˆæ“ä½œåŒºåŸŸ${currentPlayer === 1 ? 1 : 4}å†…å°çƒï¼‰`;
            balls.forEach(ball => ball.updateBallStatus());
        }

        // æ˜¾ç¤ºèƒœè´Ÿ
        function showWinResult() {
            let winText = scores[1] > scores[2] 
                ? 'ğŸ‰ ç©å®¶1è·èƒœï¼' 
                : scores[2] > scores[1] 
                    ? 'ğŸ‰ ç©å®¶2è·èƒœï¼' 
                    : 'ğŸ¤ åŒæ–¹å¹³å±€ï¼';
            winTip.textContent = winText;
            winTip.style.display = 'block';
            turnTip.textContent = 'æ¸¸æˆç»“æŸ';
        }

        // æ›´æ–°åˆ†æ•°
        function updateScore() {
            score1El.textContent = scores[1];
            score2El.textContent = scores[2];
        }

        // æ£€æŸ¥æ¸¸æˆç»“æŸ
        function checkGameOver() {
            if (!hasBallInArea(area1) && !hasBallInArea(area4)) {
                gameOver = true;
                showWinResult();
            }
        }

        // åˆå§‹åŒ–å°çƒ
        function initBalls() {
            for (let i = 0; i < ballCount; i++) {
                balls.push(new Ball(area1, i));
                balls.push(new Ball(area4, i));
            }
        }

        // é¡µé¢åŠ è½½ååˆå§‹åŒ–
        window.addEventListener('load', initBalls);
    </script>
</body>
</html>