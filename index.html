<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>分区小球弹射游戏 - 在线双人</title>
<style>
* {margin:0;padding:0;box-sizing:border-box;}
body {display:flex;flex-direction:column;align-items:center;padding-top:20px;background:#f0f0f0;touch-action:manipulation;}
.score-board {margin-bottom:15px;font-size:20px;font-weight:bold;color:#333;}
.turn-tip {margin-bottom:10px;font-size:16px;color:#666;}
.win-tip {margin-top:15px;font-size:18px;font-weight:bold;color:#e63946;display:none;}
.main-rect {width:90vw;max-width:330px;height:60vh;min-height:500px;border:3px solid #333;border-radius:8px;display:flex;flex-direction:column;overflow:hidden;position:relative;}
.area {flex:1;position:relative;}
#area1 {background:#fff;}
#area2 {background:#4ecdc4;}
#area3 {background:#ffc0cb;}
#area4 {background:#fff;}
.ball {border-radius:50%;border:2px solid #333;position:absolute;cursor:grab;user-select:none;z-index:10;}
.ball.size-xs {width:12px;height:12px;}
.ball.size-sm {width:18px;height:18px;}
.ball.size-md {width:24px;height:24px;}
.ball.size-lg {width:30px;height:30px;}
.ball.blue {background:#4287f5;}
.ball.red {background:#e63946;}
.ball.disabled {cursor:not-allowed;opacity:0.6;}
</style>
</head>
<body>

<div class="score-board">玩家1得分：<span id="score1">0</span> | 玩家2得分：<span id="score2">0</span></div>
<div class="turn-tip" id="turnTip">等待其他玩家加入...</div>
<div class="win-tip" id="winTip"></div>

<div class="main-rect" id="mainRect">
    <div class="area" id="area1"></div>
    <div class="area" id="area2"></div>
    <div class="area" id="area3"></div>
    <div class="area" id="area4"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, onDisconnect, update } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

// Firebase 配置
const firebaseConfig = {
  apiKey: "AIzaSyD2ip3Uy6ekSIq6YUfWh8-vm1t9NJf3KMo",
  authDomain: "bingqiu-fb8c7.firebaseapp.com",
  databaseURL: "https://bingqiu-fb8c7-default-rtdb.firebaseio.com",
  projectId: "bingqiu-fb8c7",
  storageBucket: "bingqiu-fb8c7.appspot.com",
  messagingSenderId: "44741898852",
  appId: "1:44741898852:web:ecbd9519b84ed62e38e571",
  measurementId: "G-5ZDPEZ193F"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// 游戏设置
const mainRect = document.getElementById('mainRect');
const area1 = document.getElementById('area1');
const area2 = document.getElementById('area2');
const area3 = document.getElementById('area3');
const area4 = document.getElementById('area4');
const allAreas = document.querySelectorAll('.area');
const score1El = document.getElementById('score1');
const score2El = document.getElementById('score2');
const turnTip = document.getElementById('turnTip');
const winTip = document.getElementById('winTip');

const ballCount = 7;
const sizeOrder = ['size-xs', 'size-sm', 'size-md', 'size-lg', 'size-md', 'size-sm', 'size-xs'];
const centerOffsets = [-90,-60,-30,0,30,60,90];
let balls = [];
let gameOver = false;
let playerNumber = null; // 1 或 2
let currentPlayer = 1;
let scores = {1:0,2:0};

// Firebase room
const roomRef = ref(db, 'rooms/room1');

// ==== 玩家加入逻辑 ====
async function joinRoom() {
    const snapshot = await get(ref(db, 'rooms/room1/players'));
    let players = snapshot.val() || {player1:false,player2:false};

    if (!players.player1) playerNumber = 1;
    else if (!players.player2) playerNumber = 2;
    else { alert("房间已满"); return; }

    const playerRef = ref(db, `rooms/room1/players/player${playerNumber}`);
    set(playerRef, true);
    onDisconnect(playerRef).set(false); // 离开自动释放

    turnTip.textContent = `你是玩家${playerNumber}，等待另一位玩家加入...`;

    // 玩家状态监听
    onValue(roomRef, snapshot => {
        const room = snapshot.val();
        const p1 = room?.players?.player1 || false;
        const p2 = room?.players?.player2 || false;
        if(p1 && p2 && !gameOver){
            turnTip.textContent = `当前轮到玩家${currentPlayer}（操作区域${currentPlayer===1?1:4}）`;
        }
    });
}

// ==== 游戏状态同步 ====
const gameStateRef = ref(db, 'rooms/room1/game');
onValue(gameStateRef, snapshot => {
    const state = snapshot.val();
    if (!state) return;

    // 更新分数
    scores = state.scores || {1:0,2:0};
    score1El.textContent = scores[1];
    score2El.textContent = scores[2];

    // 更新小球
    if(state.balls) {
        // 移除旧球
        balls.forEach(b => b.element.remove());
        balls = [];
        state.balls.forEach((b,i)=>{
            const ball = new Ball(b.belongAreaId,i);
            ball.x = b.x; ball.y = b.y;
            ball.updatePosition();
            balls.push(ball);
        });
    }
});

// ==== Ball 类 ====
class Ball {
    constructor(areaId,index){
        this.belongArea = areaId==='area1'?area1:areaId==='area4'?area4:area2;
        this.sizeClass = sizeOrder[index];
        this.element = document.createElement('div');
        this.element.className = `ball ${this.sizeClass}`;
        mainRect.appendChild(this.element);

        const areaRect = this.belongArea.getBoundingClientRect();
        const mainRectRect = mainRect.getBoundingClientRect();
        const areaCenterX = areaRect.left + areaRect.width/2 - mainRectRect.left;
        const areaCenterY = areaRect.top + areaRect.height/2 - mainRectRect.top;
        this.x = areaCenterX + centerOffsets[index] - parseInt(getComputedStyle(this.element).width)/2;
        this.y = areaCenterY - parseInt(getComputedStyle(this.element).height)/2;
        this.vx=0; this.vy=0; this.isDragging=false;
        this.updatePosition();
        this.bindEvents();
    }
    updatePosition(){this.element.style.left=this.x+'px';this.element.style.top=this.y+'px';}
    bindEvents(){
        this.element.addEventListener('mousedown',e=>this.startDrag(e.clientX,e.clientY));
        document.addEventListener('mousemove',e=>{if(this.isDragging)this.moveDrag(e.clientX,e.clientY);});
        document.addEventListener('mouseup',()=>this.endDrag());
    }
    startDrag(clientX,clientY){
        if(gameOver||playerNumber!==currentPlayer) return;
        this.isDragging=true;
        this.startX=clientX-this.x; this.startY=clientY-this.y;
    }
    moveDrag(clientX,clientY){
        this.x = clientX - this.startX;
        this.y = clientY - this.startY;
        this.updatePosition();
    }
    endDrag(){
        if(!this.isDragging) return;
        this.isDragging=false;
        this.vx=(Math.random()-0.5)*20;
        this.vy=(Math.random()-0.5)*20;
        // 更新 Firebase
        pushGameState();
        switchPlayer();
    }
}

// ==== 推送游戏状态到 Firebase ====
function pushGameState(){
    const ballsData = balls.map(b=>({belongAreaId:b.belongArea.id,x:b.x,y:b.y}));
    set(gameStateRef,{
        balls:ballsData,
        scores:scores
    });
}

// ==== 切换玩家 ====
function switchPlayer(){
    currentPlayer = currentPlayer===1?2:1;
    turnTip.textContent = `当前轮到玩家${currentPlayer}（操作区域${currentPlayer===1?1:4}）`;
}

// ==== 初始化小球 ====
function initBalls(){
    balls = [];
    for(let i=0;i<ballCount;i++){
        balls.push(new Ball('area1',i));
        balls.push(new Ball('area4',i));
    }
    pushGameState();
}

// ==== 游戏开始 ====
joinRoom().then(()=>initBalls());

</script>
</body>
</html>
